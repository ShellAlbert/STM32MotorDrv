/*
 * lens.c
 *
 *  Created on: 2019年7月30日
 *      Author: wt
 */
#include "lens.h"
#include "tim.h"
#include "drv_uart.h"

int32_t lens_pid_register(struct lens *lens, const char *name)
{
  char motor_name[2][OBJECT_NAME_MAX_LEN] = {0};
  uint8_t name_len;
  int32_t err;

  if (lens == NULL)
    return -WT_INVAL;
  if (lens_find(name) != NULL)
    return -WT_EXISTED;

  object_init(&(lens->parent), Object_Class_Lens, name);

  name_len = strlen(name);

  if (name_len > OBJECT_NAME_MAX_LEN / 2)
  {
    name_len = OBJECT_NAME_MAX_LEN / 2;
  }

  for (int i = 0; i < 2; i++)
  {
    memcpy(&motor_name[i], name, name_len);
  }

  lens->motor[left_motor].encoder_tim_handle = &htim3;
  lens->motor[left_motor].pwm_tim_handle = &htim1;
  lens->motor[left_motor].pwm_channel = TIM_CHANNEL_2;
  lens->motor[left_motor].goto_zp_flag = TRUE;

  lens->motor[right_motor].encoder_tim_handle = &htim5;
  lens->motor[right_motor].pwm_tim_handle = &htim1;
  lens->motor[right_motor].pwm_channel = TIM_CHANNEL_1;
  lens->motor[right_motor].goto_zp_flag = TRUE;

  lens->auto_focus_flag = FALSE;

  memcpy(&motor_name[left_motor][name_len], "_LEFT\0", 6);
  memcpy(&motor_name[right_motor][name_len], "_RIGHT\0", 7);

  for (int i = 0; i < 2; i++)
  {
    err = motor_device_register(&(lens->motor[i]), motor_name[i], 0);
    if (err != WT_OK)
      goto end;
  }

  pid_struct_init(&(lens->motor_pid[left_motor]),  500, 0, 1.5, 0, 0);//1.5
  pid_struct_init(&(lens->motor_pid[right_motor]), 500, 0, 1.5, 0, 0);//1.5

  return WT_OK;
end:
  object_detach(&(lens->parent));

  return err;
}


lens_t lens_find(const char *name)
{
  struct object *object;

  object = object_find(name, Object_Class_Lens);

  return (lens_t)object;
}

float motor_out;
int32_t lens_execute(struct lens *lens)
{
  if (lens == NULL)
    return -WT_INVAL;

  motor_out = pid_calculate(&(lens->motor_pid[left_motor]), __HAL_TIM_GET_COUNTER(&htim3), lens->motor[left_motor].target);
  motor_device_set_current(&(lens->motor[left_motor]), motor_out);


  motor_out = pid_calculate(&(lens->motor_pid[right_motor]), __HAL_TIM_GET_COUNTER(&htim5), lens->motor[right_motor].target);
  motor_device_set_current(&(lens->motor[right_motor]), motor_out);

  return WT_OK;
}

void lens_set_left_motor_target(int16_t target, struct lens *lens)
{
//	taskENTER_CRITICAL();
	lens->motor[left_motor].target += target;
	VAL_LIMIT(lens->motor[left_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
//	taskEXIT_CRITICAL();

}

void lens_set_right_motor_target(int16_t target, struct lens *lens)
{
//	taskENTER_CRITICAL();
	lens->motor[right_motor].target  += target;
	VAL_LIMIT(lens->motor[right_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
//	taskEXIT_CRITICAL();
}


#ifdef NEW_001
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{50,0},{51,709},{52,1418},{53,2127},{54,2836},{55,3545},{56,4254},{57,4963},{58,5672},{59,6381},{60,7090},
		{61,7799},{62,8508},{63,9217},{64,9926},{65,10635},{66,11344},{67,12053},{68,12762},{69,13471},{70,14180},
		{71,14889},{72,15598},{73,16307},{74,17016},{75,17725},{76,18434},{77,19143},{78,19852},{79,20561},{80,21270},
		{81,21979},{82,22688},{83,23397},{84,24106},{85,24815},{86,25524},{87,26233},{88,26942},{89,27651},{90,28360},
		{91,29069},{92,29778},{93,30487},{94,31196},{95,31905},{96,32614},{97,33323},{98,34032},{99,34741},{100,35450},
		{101,36159},{102,36868},{103,37577},{104,38286},{105,38995},{106,39704},{107,40413},{108,41122},{109,41831},{110,42540},
		{111,43249},{112,43958},{113,44667},{114,45376},{115,46085},{116,46794},{117,47503},{118,48212},{119,48921},{120,49630},
		{121,50339},{122,51048},{123,51757},{124,52466},{125,53175},{126,53884},{127,54593},{128,55302},{129,56011},{130,56720},
		{131,57429},{132,58138},{133,58847},{134,59556},{135,60265},{136,60995},{137,60995},{138,60995},{139,60995},{140,60995},
		{141,60995},{142,60995},{143,60995},{144,60995},{145,60995},{146,60995},{147,60995},{148,60995},{149,60995},{150,60995},
		{151,60995},{152,60995},{153,60995},{154,60995},{155,60995},{156,60995},{157,60995},{158,60995},{159,60995},{160,60995},
		{161,60995},{162,60995},{163,60995},{164,60995},{165,60995},{166,60995},{167,60995},{168,60995},{169,60995},{170,60995},
		{171,60995},{172,60995},{173,60995},{174,60995},{175,60995},{176,60995},{177,60995},{178,60995},{179,60995},{180,60995},
		{181,60995},{182,60995},{183,60995},{184,60995},{185,60995},{186,60995},{187,60995},{188,60995},{189,60995},{190,60995},
		{191,60995},{192,60995},{193,60995},{194,60995},{195,60995},{196,60995},{197,60995},{198,60995},{199,60995},{200,60995},
		{201,60995},{202,60995},{203,60995},{204,60995},{205,60995},{206,60995},{207,60995},{208,60995},{209,60995},{210,60995},
		{211,60995},{212,60995},{213,60995},{214,60995},{215,60995},{216,60995},{217,60995},{218,60995},{219,60995},{220,60995},
		{221,60995},{222,60995},{223,60995},{224,60995},{225,60995},{226,60995},{227,60995},{228,60995},{229,60995},{230,60995},
		{231,60995},{232,60995},{233,60995},{234,60995},{235,60995},{236,60995},{237,60995},{238,60995},{239,60995},{240,60995},
		{241,60995},{242,60995},{243,60995},{244,60995},{245,60995},{246,60995},{247,60995},{248,60995},{249,60995},{250,60995}};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{50,0},{51,709},{52,1418},{53,2127},{54,2836},{55,3545},{56,4254},{57,4963},{58,5672},{59,6381},{60,7090},
		{61,7799},{62,8508},{63,9217},{64,9926},{65,10635},{66,11344},{67,12053},{68,12762},{69,13471},{70,14180},
		{71,14889},{72,15598},{73,16307},{74,17016},{75,17725},{76,18434},{77,19143},{78,19852},{79,20561},{80,21270},
		{81,21979},{82,22688},{83,23397},{84,24106},{85,24815},{86,25524},{87,26233},{88,26942},{89,27651},{90,28360},
		{91,29069},{92,29778},{93,30487},{94,31196},{95,31905},{96,32614},{97,33323},{98,34032},{99,34741},{100,35450},
		{101,36159},{102,36868},{103,37577},{104,38286},{105,38995},{106,39704},{107,40413},{108,41122},{109,41831},{110,42540},
		{111,43249},{112,43958},{113,44667},{114,45376},{115,46085},{116,46794},{117,47503},{118,48212},{119,48921},{120,49630},
		{121,50339},{122,51048},{123,51757},{124,52466},{125,53175},{126,53884},{127,54593},{128,55302},{129,56011},{130,56720},
		{131,57429},{132,58138},{133,58847},{134,59556},{135,60265},{136,60995},{137,60995},{138,60995},{139,60995},{140,60995},
		{141,60995},{142,60995},{143,60995},{144,60995},{145,60995},{146,60995},{147,60995},{148,60995},{149,60995},{150,60995},
		{151,60995},{152,60995},{153,60995},{154,60995},{155,60995},{156,60995},{157,60995},{158,60995},{159,60995},{160,60995},
		{161,60995},{162,60995},{163,60995},{164,60995},{165,60995},{166,60995},{167,60995},{168,60995},{169,60995},{170,60995},
		{171,60995},{172,60995},{173,60995},{174,60995},{175,60995},{176,60995},{177,60995},{178,60995},{179,60995},{180,60995},
		{181,60995},{182,60995},{183,60995},{184,60995},{185,60995},{186,60995},{187,60995},{188,60995},{189,60995},{190,60995},
		{191,60995},{192,60995},{193,60995},{194,60995},{195,60995},{196,60995},{197,60995},{198,60995},{199,60995},{200,60995},
		{201,60995},{202,60995},{203,60995},{204,60995},{205,60995},{206,60995},{207,60995},{208,60995},{209,60995},{210,60995},
		{211,60995},{212,60995},{213,60995},{214,60995},{215,60995},{216,60995},{217,60995},{218,60995},{219,60995},{220,60995},
		{221,60995},{222,60995},{223,60995},{224,60995},{225,60995},{226,60995},{227,60995},{228,60995},{229,60995},{230,60995},
		{231,60995},{232,60995},{233,60995},{234,60995},{235,60995},{236,60995},{237,60995},{238,60995},{239,60995},{240,60995},
		{241,60995},{242,60995},{243,60995},{244,60995},{245,60995},{246,60995},{247,60995},{248,60995},{249,60995},{250,60995}};
#endif


#ifdef NEW_002
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{29,12200},{30,12400},{31,12500},{32,13000},{33,13500},{34,14000},{35,14500},{36,15000},{37,15500},{38,16083},{39,16666},{40,17249},{41,17832},
		{42,18415},{43,19000},{44,20000},{45,21000},{46,22000},{47,23000},{48,23307},{49,23614},{50,23921},{51,24228},
		{52,24535},{53,24842},{54,25149},{55,25456},{56,25763},{57,26070},{58,26377},{59,26684},{60,27000},{61,27416},
		{62,27832},{63,28248},{64,28664},{65,29080},{66,29500},{67,29619},{68,29738},{69,29857},{70,29976},{71,30095},
		{72,30214},{73,30333},{74,30452},{75,30571},{76,30690},{77,30809},{78,30928},{79,31047},{80,31166},{81,31285},
		{82,31404},{83,31523},{84,31642},{85,31761},{86,31880},{87,32000},{88,32050},{89,32100},{90,32150},{91,32200},
		{92,32250},{93,32300},{94,32350},{95,32400},{96,32450},{97,32500},{98,32550},{99,32600},{100,32650},{101,32700},
		{102,32750},{103,32800},{104,32850},{105,32900},{106,32950},{107,33000},{108,33050},{109,33100},{110,33150},{111,33200},
		{112,33250},{113,33300},{114,33350},{115,33400},{116,33450},{117,33500},{118,33578},{119,33656},{120,33734},{121,33812},
		{122,33890},{123,33968},{124,34046},{125,34124},{126,34202},{127,34280},{128,34358},{129,34436},{130,34514},{131,34592},
		{132,34670},{133,34748},{134,34826},{135,34904},{136,34982},{137,35060},{138,35138},{139,35216},{140,35294},{141,35372},
		{142,35450},{143,35528},{144,35606},{145,35684},{146,35762},{147,35840},{148,35918},{149,35996},{150,36074},{151,36152},
		{152,36230},{153,36308},{154,36386},{155,36500},{156,36513},{157,36526},{158,36539},{159,36552},{160,36565},{161,36578},
		{162,36591},{163,36604},{164,36617},{165,36630},{166,36643},{167,36656},{168,36669},{169,36682},{170,36695},{171,36708},
		{172,36721},{173,36734},{174,36747},{175,36760},{176,36773},{177,36786},{178,36799},{179,36812},{180,36825},{181,36838},
		{182,36851},{183,36864},{184,36877},{185,36890},{186,36903},{187,36916},{188,36929},{189,36942},{190,36955},{191,36968},
		{192,36981},{193,36994},{194,37007},{195,37020},{196,37033},{197,37046},{198,37059},{199,37072},{200,37085},{201,37098},
		{202,37111},{203,37124},{204,37137},{205,37150},{206,37163},{207,37176},{208,37189},{209,37202},{210,37215},{211,37228},
		{212,37241},{213,37254},{214,37267},{215,37280},{216,37293},{217,37306},{218,37319},{219,37332},{220,37345},{221,37358},
		{222,37371},{223,37384},{224,37397},{225,37410},{226,37423},{227,37436},{228,37449},{229,37462},{230,37475},{231,37500},
		{232,37502},{233,37504},{234,37506},{235,37508},{236,37510},{237,37512},{238,37514},{239,37516},{240,37518},{241,37520},
		{242,37522},{243,37524},{244,37526},{245,37528},{246,37530},{247,37532},{248,37534},{249,37536},{250,37538},{251,37540},
		{252,37542},{253,37544},{254,37546},{255,37548},{256,37550},{257,37552},{258,37554},{259,37556},{260,37558},{261,37560},
		{262,37562},{263,37564},{264,37566},{265,37568},{266,37570},{267,37572},{268,37574},{269,37576},{270,37578},{271,37580},
		{272,37582},{273,37584},{274,37586},{275,37588},{276,37590},{277,37592},{278,37594},{279,37596},{280,37598},{281,37600},
		{282,37602},{283,37604},{284,37606},{285,37608},{286,37610},{287,37612},{288,37614},{289,37616},{290,37618},{291,37620},
		{292,37622},{293,37624},{294,37626},{295,37628},{296,37630},{297,37632},{298,37634},{299,37636},{300,37700},{350,37800},{400,37900}};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{29,18700},{30,18900},{31,19000},{32,19333},{33,19666},{34,19999},{35,20332},{36,20665},{37,21000},{38,21750},{39,22500},{40,23250},{41,24000},
		{42,24750},{43,25500},{44,26500},{45,27500},{46,28500},{47,29500},{48,29807},{49,30114},{50,30421},{51,30728},
		{52,31035},{53,31342},{54,31649},{55,31956},{56,32263},{57,32570},{58,32877},{59,33184},{60,33500},{61,33666},
		{62,33832},{63,33998},{64,34164},{65,34330},{66,34500},{67,34595},{68,34690},{69,34785},{70,34880},{71,34975},
		{72,35070},{73,35165},{74,35260},{75,35355},{76,35450},{77,35545},{78,35640},{79,35735},{80,35830},{81,35925},
		{82,36020},{83,36115},{84,36210},{85,36305},{86,36400},{87,36500},{88,36666},{89,36832},{90,36998},{91,37164},
		{92,37330},{93,37496},{94,37662},{95,37828},{96,37994},{97,38160},{98,38326},{99,38492},{100,38658},{101,38824},
		{102,38990},{103,39156},{104,39322},{105,39488},{106,39654},{107,39820},{108,39986},{109,40152},{110,40318},{111,40484},
		{112,40650},{113,40816},{114,40982},{115,41148},{116,41314},{117,41500},{118,41552},{119,41604},{120,41656},{121,41708},
		{122,41760},{123,41812},{124,41864},{125,41916},{126,41968},{127,42020},{128,42072},{129,42124},{130,42176},{131,42228},
		{132,42280},{133,42332},{134,42384},{135,42436},{136,42488},{137,42540},{138,42592},{139,42644},{140,42696},{141,42748},
		{142,42800},{143,42852},{144,42904},{145,42956},{146,43008},{147,43060},{148,43112},{149,43164},{150,43216},{151,43268},
		{152,43320},{153,43372},{154,43424},{155,43500},{156,43532},{157,43564},{158,43596},{159,43628},{160,43660},{161,43692},
		{162,43724},{163,43756},{164,43788},{165,43820},{166,43852},{167,43884},{168,43916},{169,43948},{170,43980},{171,44012},
		{172,44044},{173,44076},{174,44108},{175,44140},{176,44172},{177,44204},{178,44236},{179,44268},{180,44300},{181,44332},
		{182,44364},{183,44396},{184,44428},{185,44460},{186,44492},{187,44524},{188,44556},{189,44588},{190,44620},{191,44652},
		{192,44684},{193,44716},{194,44748},{195,44780},{196,44812},{197,44844},{198,44876},{199,44908},{200,44940},{201,44972},
		{202,45004},{203,45036},{204,45068},{205,45100},{206,45132},{207,45164},{208,45196},{209,45228},{210,45260},{211,45292},
		{212,45324},{213,45356},{214,45388},{215,45420},{216,45452},{217,45484},{218,45516},{219,45548},{220,45580},{221,45612},
		{222,45644},{223,45676},{224,45708},{225,45740},{226,45772},{227,45804},{228,45836},{229,45868},{230,45900},{231,46000},
		{232,46002},{233,46004},{234,46006},{235,46008},{236,46010},{237,46012},{238,46014},{239,46016},{240,46018},{241,46020},
		{242,46022},{243,46024},{244,46026},{245,46028},{246,46030},{247,46032},{248,46034},{249,46036},{250,46038},{251,46040},
		{252,46042},{253,46044},{254,46046},{255,46048},{256,46050},{257,46052},{258,46054},{259,46056},{260,46058},{261,46060},
		{262,46062},{263,46064},{264,46066},{265,46068},{266,46070},{267,46072},{268,46074},{269,46076},{270,46078},{271,46080},
		{272,46082},{273,46084},{274,46086},{275,46088},{276,46090},{277,46092},{278,46094},{279,46096},{280,46098},{281,46100},
		{282,46102},{283,46104},{284,46106},{285,46108},{286,46110},{287,46112},{288,46114},{289,46116},{290,46118},{291,46120},
		{292,46122},{293,46124},{294,46126},{295,46128},{296,46130},{297,46132},{298,46134},{299,46136},{300,46200},{350,46300},{400,46400}};
#endif


void lens_set_motors_target_by_distance(uint16_t distance, struct lens *lens)
{
	uint16_t i = 0;
	if( (distance>300) && (distance<=350) )
	{
		distance = 350;
	}
	else if( distance>350 )
	{
		distance = 400;
	}

	if(distance<=28)
	{
		lens->motor[left_motor].target = left_motor_zp;
		lens->motor[right_motor].target = right_motor_zp;
		return;
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(left_motor_table[i][0] == distance)
		{
			lens->motor[left_motor].target = left_motor_table[i][1];
			break;
		}
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(right_motor_table[i][0] == distance)
		{
			lens->motor[right_motor].target = right_motor_table[i][1];
			break;
		}
	}
}
